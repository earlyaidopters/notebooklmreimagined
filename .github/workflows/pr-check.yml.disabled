# PR Check Workflow - Quick validation before merge
# Runs on all PRs to main/develop branches

name: PR Check

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Job 1: Quick backend smoke tests
  backend-smoke:
    name: Backend Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Python syntax
        working-directory: ./backend
        run: |
          python -m py_compile app/**/*.py || true
          python -m py_compile api/**/*.py || true

      - name: Check imports
        working-directory: ./backend
        run: |
          python -c "from app.config import get_settings" || true
          python -c "from app.services.openrouter import OpenRouterService" || true

  # Job 2: Quick frontend smoke tests
  frontend-smoke:
    name: Frontend Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Type check
        working-directory: ./frontend
        run: npm run type-check
        continue-on-error: true

      - name: Lint check
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

  # Job 3: Check for common issues
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" --include="*.py" --include="*.ts" --include="*.tsx" . || echo "No TODOs found"

      - name: Check for console.log statements
        working-directory: ./frontend
        run: |
          echo "Checking for console.log statements..."
          grep -r "console\.log" src/ || echo "No console.log found"
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "Checking file sizes..."
          find backend/app -name "*.py" -size +500k -exec ls -lh {} \; || echo "No large Python files"
          find frontend/src -name "*.tsx" -o -name "*.ts" | xargs wc -l | sort -n | tail -10 || echo "File size check complete"

  # Job 4: PR summary
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [backend-smoke, frontend-smoke, code-quality]
    if: always()
    steps:
      - name: Generate PR summary
        run: |
          echo "# PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Smoke: ${{ needs.backend-smoke.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Smoke: ${{ needs.frontend-smoke.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
