# Backend CI/CD Pipeline for OpenRouter Integration
# Tests the FastAPI backend with multi-LLM provider support

name: Backend CI

on:
  push:
    branches: [main, develop, feature/**]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Job 1: Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest-asyncio
          pip install -r requirements.txt

      - name: Run ruff linter
        working-directory: ./backend
        run: |
          ruff check . --output-format=github
        continue-on-error: true

      - name: Type check with mypy
        working-directory: ./backend
        run: |
          mypy app/ --ignore-missing-imports
        continue-on-error: true

  # Job 2: Unit Tests (No external API calls)
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov
          pip install -r requirements.txt

      - name: Create test environment
        working-directory: ./backend
        run: |
          touch .env
          echo "SUPABASE_URL=https://test.supabase.co" >> .env
          echo "SUPABASE_ANON_KEY=test_key" >> .env
          echo "GOOGLE_API_KEY=test_key_for_unit_tests" >> .env
          echo "OPENROUTER_API_KEY=" >> .env
          echo "DEFAULT_LLM_PROVIDER=google" >> .env
          echo "OPENROUTER_DEFAULT_MODEL=anthropic/claude-3.5-sonnet" >> .env

      - name: Run unit tests (without API keys)
        working-directory: ./backend
        run: |
          pytest test_providers.py -v -m "not integration" --tb=short
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: backend/test-results/
          retention-days: 7

  # Job 3: Integration Tests (With API keys)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov
          pip install -r requirements.txt

      - name: Create environment with secrets
        working-directory: ./backend
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          touch .env
          echo "SUPABASE_URL=${SUPABASE_URL}" >> .env
          echo "SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env
          if [ -n "$GOOGLE_API_KEY" ]; then
            echo "GOOGLE_API_KEY=${GOOGLE_API_KEY}" >> .env
          fi
          if [ -n "$OPENROUTER_API_KEY" ]; then
            echo "OPENROUTER_API_KEY=${OPENROUTER_API_KEY}" >> .env
          fi
          echo "DEFAULT_LLM_PROVIDER=google" >> .env
          echo "OPENROUTER_DEFAULT_MODEL=anthropic/claude-3.5-sonnet" >> .env

      - name: Run integration tests (with API keys)
        working-directory: ./backend
        run: |
          python test_providers.py
        continue-on-error: true

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: backend/test-results/
          retention-days: 7

  # Job 4: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security linter
        working-directory: ./backend
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        working-directory: ./backend
        run: |
          safety check --json > safety-report.json || true
        continue-on-error: true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            backend/bandit-report.json
            backend/safety-report.json
          retention-days: 30

  # Job 5: Build and Deploy (main branch only)
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [test-integration, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ secrets.BACKEND_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deployment dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install mangum uvicorn

      - name: Build deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy
          cp -r app/ deploy/
          cp -r api/ deploy/ || true
          cp requirements.txt deploy/
          cp vercel.json deploy/ || echo "No vercel.json found"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-deployment
          path: backend/deploy/
          retention-days: 7

      - name: Deploy to production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Backend deployment artifact ready for Vercel"
          echo "Deploy to: ${{ secrets.BACKEND_URL }}"

  # Job 6: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration, security-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate test summary
        run: |
          echo "# Backend CI/CD Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.test-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
