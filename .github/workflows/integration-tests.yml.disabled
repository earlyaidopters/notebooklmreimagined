# Integration Tests for OpenRouter Provider Feature
# Tests the complete flow: Frontend -> Backend -> OpenRouter API

name: Integration Tests

on:
  push:
    branches: [main, develop, feature/openrouter-integration]
    paths:
      - 'backend/app/services/openrouter.py'
      - 'backend/app/api/providers.py'
      - 'frontend/src/components/ProviderSelector.tsx'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/app/services/openrouter.py'
      - 'backend/app/api/providers.py'
      - 'frontend/src/components/ProviderSelector.tsx'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Job 1: Start Supabase Local Stack
  setup-supabase:
    name: Setup Supabase Local
    runs-on: ubuntu-latest
    services:
      postgres:
        image: supabase/postgres:15.1.0.147
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    outputs:
      postgres-url: postgres://postgres:postgres@localhost:5432/postgres
    steps:
      - name: Check PostgreSQL is running
        run: |
          pg_isready -h localhost -p 5432
          echo "PostgreSQL is ready"

  # Job 2: Backend Integration Tests
  backend-integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: setup-supabase
    strategy:
      matrix:
        test-suite:
          - name: provider-endpoints
            file: test_providers.py
          - name: openrouter-service
            file: test_providers.py
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Create test environment
        working-directory: ./backend
        env:
          SUPABASE_URL: ${{ needs.setup-supabase.outputs.postgres-url }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          cat > .env << EOF
          SUPABASE_URL=${SUPABASE_URL}
          SUPABASE_ANON_KEY=test_anon_key
          SUPABASE_SERVICE_ROLE_KEY=test_service_key
          DEFAULT_LLM_PROVIDER=google
          OPENROUTER_DEFAULT_MODEL=anthropic/claude-3.5-sonnet
          EOF

          # Add API keys if available
          if [ -n "$GOOGLE_API_KEY" ]; then
            echo "GOOGLE_API_KEY=$GOOGLE_API_KEY" >> .env
          else
            echo "GOOGLE_API_KEY=test_key" >> .env
          fi

          if [ -n "$OPENROUTER_API_KEY" ]; then
            echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" >> .env
          fi

      - name: Run backend integration tests
        working-directory: ./backend
        run: |
          python ${{ matrix.test-suite.file }}
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-${{ matrix.test-suite.name }}
          path: |
            backend/test-results/
            backend/*.log
          retention-days: 7

  # Job 3: Frontend Integration Tests
  frontend-integration:
    name: Frontend Integration Tests
    runs-on: ubuntu-latest
    needs: setup-supabase
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Create environment file
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ needs.setup-supabase.outputs.postgres-url }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test_anon_key
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
          EOF

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Check ProviderSelector component
        run: |
          if [ -f "frontend/src/components/ProviderSelector.tsx" ]; then
            echo "ProviderSelector component exists"
            grep -l "openrouter\|OpenRouter" frontend/src/components/ProviderSelector.tsx || echo "Warning: OpenRouter not mentioned in ProviderSelector"
          else
            echo "ProviderSelector component not found"
          fi

      - name: Upload build results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-integration-build
          path: frontend/.next/
          retention-days: 7

  # Job 4: End-to-End API Tests
  e2e-api-tests:
    name: E2E API Tests
    runs-on: ubuntu-latest
    needs: [backend-integration, frontend-integration]
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-e2e]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Start backend server
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
          curl -f http://localhost:8000/api/v1/health || echo "Backend not ready"

      - name: Run API tests
        run: |
          # Test GET /api/v1/providers
          curl -f http://localhost:8000/api/v1/providers || true

          # Test GET /api/v1/providers/config
          curl -f http://localhost:8000/api/v1/providers/config || true

          # Test GET /api/v1/providers/models
          curl -f http://localhost:8000/api/v1/providers/models || true
        continue-on-error: true

  # Job 5: Test Summary
  test-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [backend-integration, frontend-integration, e2e-api-tests]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature:** OpenRouter Integration" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Integration: ${{ needs.backend-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Integration: ${{ needs.frontend-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E API Tests: ${{ needs.e2e-api-tests.result }}" >> $GITHUB_STEP_SUMMARY
